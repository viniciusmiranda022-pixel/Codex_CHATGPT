<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*"
           Name="DirectoryAnalyzer Agent"
           Language="1033"
           Version="1.0.0.0"
           Manufacturer="DirectoryAnalyzer"
           UpgradeCode="{45BFD46A-7F6A-4A34-9B2E-6E053E845237}">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate />

    <Property Id="ARPNOREPAIR" Value="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" />

    <Property Id="SERVICEACCOUNT" Value="NT AUTHORITY\LocalService" />
    <Property Id="SERVICEPASSWORD" Value="" Hidden="yes" />
    <Property Id="LISTENPORT" Value="8443" />
    <Property Id="BINDPREFIX" Value="https://+:8443/agent/" />
    <Property Id="CERTTHUMBPRINT" Value="" />
    <Property Id="ALLOWEDCLIENTCERTTHUMBPRINTS" Value="" />
    <Property Id="TRUSTEDCATHUMBPRINTS" Value="" />
    <Property Id="CREATEFIREWALLRULE" Value="0" />
    <Property Id="ACTIONTIMEOUTSECONDS" Value="30" />
    <Property Id="LOGPATH" Value="C:\ProgramData\DirectoryAnalyzerAgent\Logs\agent.log" />
    <Property Id="DOMAIN" Value="" />
    <Property Id="MAXREQUESTBYTES" Value="65536" />
    <Property Id="REQUESTCLOCKSKEWSECONDS" Value="300" />
    <Property Id="REPLAYCACHEMINUTES" Value="10" />
    <Property Id="REQUIRESIGNEDREQUESTS" Value="1" />
    <Property Id="MAXREQUESTSPERMINUTE" Value="60" />
    <Property Id="MAXCONCURRENTREQUESTS" Value="10" />
    <Property Id="ENFORCEREVOCATIONCHECK" Value="1" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="AgentInstallFolder" Name="DirectoryAnalyzerAgent" />
      </Directory>
      <Directory Id="CommonAppDataFolder">
        <Directory Id="ProgramDataFolder" Name="DirectoryAnalyzerAgent" />
      </Directory>
    </Directory>

    <ComponentGroup Id="AgentComponents">
      <Component Id="AgentExeComponent" Guid="{2F35D74E-5DA4-4A2F-9A1E-6D6F1B9FE0F0}" Directory="AgentInstallFolder">
        <File Id="AgentExe" Source="$(var.AgentService.TargetDir)DirectoryAnalyzer.Agent.exe" KeyPath="yes" />
        <File Id="AgentContractsDll" Source="$(var.AgentService.TargetDir)DirectoryAnalyzer.AgentContracts.dll" />
        <ServiceInstall Id="AgentServiceInstall"
                        Type="ownProcess"
                        Name="DirectoryAnalyzerAgent"
                        DisplayName="DirectoryAnalyzer Agent"
                        Description="DirectoryAnalyzer on-prem agent service"
                        Start="auto"
                        ErrorControl="normal"
                        Account="[SERVICEACCOUNT]"
                        Password="[SERVICEPASSWORD]" />
        <ServiceControl Id="StartAgentService" Name="DirectoryAnalyzerAgent" Start="install" Stop="both" Remove="uninstall" Wait="yes" />
      </Component>
      <Component Id="AgentConfigComponent" Guid="{90B4A7B6-6B69-4C12-99B3-9A09E2B0D1FA}" Directory="ProgramDataFolder">
        <CreateFolder />
      </Component>
      <Component Id="AgentRegistryComponent" Guid="{6D7A6F8E-58F1-4BB1-9CE4-4A72346A0A55}" Directory="ProgramDataFolder">
        <RegistryKey Root="HKLM" Key="SOFTWARE\DirectoryAnalyzer\Agent">
          <RegistryValue Name="BindPrefix" Type="string" Value="[BINDPREFIX]" KeyPath="yes" />
          <RegistryValue Name="CertThumbprint" Type="string" Value="[CERTTHUMBPRINT]" />
          <RegistryValue Name="AnalyzerClientThumbprints" Type="string" Value="[ALLOWEDCLIENTCERTTHUMBPRINTS]" />
          <RegistryValue Name="TrustedCaThumbprints" Type="string" Value="[TRUSTEDCATHUMBPRINTS]" />
          <RegistryValue Name="ActionTimeoutSeconds" Type="integer" Value="[ACTIONTIMEOUTSECONDS]" />
          <RegistryValue Name="LogPath" Type="string" Value="[LOGPATH]" />
          <RegistryValue Name="Domain" Type="string" Value="[DOMAIN]" />
          <RegistryValue Name="MaxRequestBytes" Type="integer" Value="[MAXREQUESTBYTES]" />
          <RegistryValue Name="RequestClockSkewSeconds" Type="integer" Value="[REQUESTCLOCKSKEWSECONDS]" />
          <RegistryValue Name="ReplayCacheMinutes" Type="integer" Value="[REPLAYCACHEMINUTES]" />
          <RegistryValue Name="RequireSignedRequests" Type="integer" Value="[REQUIRESIGNEDREQUESTS]" />
          <RegistryValue Name="MaxRequestsPerMinute" Type="integer" Value="[MAXREQUESTSPERMINUTE]" />
          <RegistryValue Name="MaxConcurrentRequests" Type="integer" Value="[MAXCONCURRENTREQUESTS]" />
          <RegistryValue Name="EnforceRevocationCheck" Type="integer" Value="[ENFORCEREVOCATIONCHECK]" />
        </RegistryKey>
      </Component>
    </ComponentGroup>

    <CustomAction Id="SetBindPrefix"
                  Property="BINDPREFIX"
                  Value="https://+:[LISTENPORT]/agent/"
                  Execute="immediate" />
    <CustomAction Id="CreateAgentConfig"
                  Directory="ProgramDataFolder"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  ExeCommand="&quot;[SystemFolder]WindowsPowerShell\\v1.0\\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;$port=[int]''[LISTENPORT]''; $bindPrefix=&quot;&quot;https://+:$port/agent/&quot;&quot;; $allowed=''[ALLOWEDCLIENTCERTTHUMBPRINTS]''.Split('';'') | Where-Object { $_ -and $_.Trim() -ne '''' } | ForEach-Object { $_.Trim() }; $trusted=''[TRUSTEDCATHUMBPRINTS]''.Split('';'') | Where-Object { $_ -and $_.Trim() -ne '''' } | ForEach-Object { $_.Trim() }; $config=[ordered]@{ BindPrefix=$bindPrefix; CertThumbprint=''[CERTTHUMBPRINT]''; AnalyzerClientThumbprints=$allowed; TrustedCaThumbprints=$trusted; ActionTimeoutSeconds=[int]''[ACTIONTIMEOUTSECONDS]''; LogPath=''[LOGPATH]''; Domain=''[DOMAIN]''; MaxRequestBytes=[int]''[MAXREQUESTBYTES]''; RequestClockSkewSeconds=[int]''[REQUESTCLOCKSKEWSECONDS]''; ReplayCacheMinutes=[int]''[REPLAYCACHEMINUTES]''; RequireSignedRequests=([int]''[REQUIRESIGNEDREQUESTS]'' -ne 0); MaxRequestsPerMinute=[int]''[MAXREQUESTSPERMINUTE]''; MaxConcurrentRequests=[int]''[MAXCONCURRENTREQUESTS]''; EnforceRevocationCheck=([int]''[ENFORCEREVOCATIONCHECK]'' -ne 0) }; $configPath=''[ProgramDataFolder]agentsettings.json''; $configDir=Split-Path $configPath; New-Item -ItemType Directory -Path $configDir -Force | Out-Null; $config | ConvertTo-Json -Depth 6 | Set-Content -Path $configPath -Encoding UTF8&quot;" />
    <CustomAction Id="AddFirewallRule"
                  Directory="SystemFolder"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  ExeCommand="&quot;[SystemFolder]netsh.exe&quot; advfirewall firewall add rule name=&quot;DirectoryAnalyzer Agent&quot; dir=in action=allow protocol=TCP localport=[LISTENPORT]" />
    <CustomAction Id="RemoveFirewallRule"
                  Directory="SystemFolder"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  ExeCommand="&quot;[SystemFolder]netsh.exe&quot; advfirewall firewall delete rule name=&quot;DirectoryAnalyzer Agent&quot; protocol=TCP localport=[LISTENPORT]" />

    <InstallExecuteSequence>
      <Custom Action="SetBindPrefix" Before="InstallInitialize">NOT REMOVE="all"</Custom>
      <Custom Action="CreateAgentConfig" After="InstallFiles">NOT REMOVE="all"</Custom>
      <Custom Action="AddFirewallRule" After="CreateAgentConfig">CREATEFIREWALLRULE=1 AND NOT REMOVE="all"</Custom>
      <Custom Action="RemoveFirewallRule" Before="RemoveFiles">REMOVE="all"</Custom>
    </InstallExecuteSequence>

    <Feature Id="AgentFeature" Title="DirectoryAnalyzer Agent" Level="1">
      <ComponentGroupRef Id="AgentComponents" />
    </Feature>
  </Product>
</Wix>
